---
title: "BANA4137 Case 2 - CVG Flights"
author: "Nicholas Kemper"
date: "2/13/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

This case analyzes a flights to and from CVG airport. Each observation represents one flight either to or from CVG airport.

## Packages used

The following packages are used in this analysis for data processing and visualizations.

```{r message = FALSE}
# For data processing
library(tidyverse)
library(reshape2)
# For maps
library(maps)
# For plots
library(corrplot)

library(maps)
library(ggmap)
library(leaflet)
library(htmlwidgets) # replacing leaflets
library(ggplot2)
library(maps)
library(geosphere)
```


# 1 Describing the dataset

First we must read in and merge all the data into a single dataframe. The code below will handle this.

```{r}
# 1 Read in and setup ----
flights <- read.csv("CVG_Flights.csv", header = TRUE, stringsAsFactors = FALSE, na.strings = "")
flights$FLIGHT_DATE <- as.Date(as.character(flights$FLIGHT_DATE), format = "%m/%d/%y")
airports <-  read.csv("airports.csv", header = TRUE, stringsAsFactors = FALSE, na.strings = "")
airlines <-  read.csv("airlines.csv", header = TRUE, stringsAsFactors = FALSE, na.strings = "")

# Merge all the data
first_dataframe <- left_join(flights, 
                             airlines, 
                             by=c("AIRLINE"="IATA_CODE"))
head(first_dataframe)
all_flights <- left_join(first_dataframe,
                             airports,
                             by=c("ORIGIN_AIRPORT"="IATA_CODE"))
```


The below code will tell us how many variables and observations are in each dataset

How many rows are there in each data frame?

```{r}
nrow(flights)
nrow(airports)
nrow(airlines)
```

How many columns are there in each data frame?

```{r}
ncol(flights)
ncol(airports)
ncol(airlines)
```


Next we can look into missing values in the dataset. The below code will find all the missing values in the overall dataset.

```{r}
na.vals <- apply(is.na(all_flights), 2, which)
# Columns containing NA values
na.vals <- na.vals[lapply(na.vals,length)>0]

# Columns containing NA values
names(na.vals)
```

As it turns out, values are missing in certain columns when a flight is canceled.

# Describing each variable

Next we will look into each variable in the datset and provide a summary and some analysis.

```FLIGHT_DATE``` descibes the date of the flight

```{r}
max(all_flights$FLIGHT_DATE)
min(all_flights$FLIGHT_DATE)
```

Flgihts range only from 01/01/15 - 01/03/15

```AIRLINE``` descibes the airline of the flight

```{r}
all_flights %>% 
  group_by(AIRLINE) %>% 
  count() %>% 
  arrange(desc(n))
```

The ```Airlines``` dataset helps translate these values to actual airlines, there are no missing values

```{r}
airlines


```

```FLIGHT_NUMBER``` descibes flight number for the flight

```ORIGIN_AIRPORT``` and ```DESTINATION_AIRPORT``` descibe the airports of the origin and destination of the flight.

Below describes the two variables

```{r}
all_flights %>% 
  group_by(ORIGIN_AIRPORT) %>% 
  count() %>% 
  arrange(desc(n))


all_flights %>% 
  group_by(DESTINATION_AIRPORT) %>% 
  count() %>% 
  arrange(desc(n))
```

The majority of origin and destination is CVG, this makes sense as it is a CVG dataset

```SCHEDULED_DEPARTURE``` is the time the flight was scheduled
```DEPARTURE_TIME``` is the actual departure time
```DEPARTURE_DELAY``` is the delay between the scheduled and actual departure

Below is the distribution of the departure delay

```{r}
hist(flights$DEPARTURE_DELAY)
```

Majority of the time there is no delay, but there can be long delays.

```TAXI_OUT``` refers to the amount of time it takes the airline to get to the runway and takeoff from departure time.
```WHEELS_OFF``` is the time when the wheels leave the runway.
The distribution of ```TAXI_OUT``` is below:

```{r}
hist(flights$TAXI_OUT)
```

It usually takes ~15 minutes for a flight to be taxied out to the runway

```SCHEDULED_TIME``` is the estimated time of a flight. It's distribution is below.

```{r}
hist(flights$SCHEDULED_TIME)
```


Most flights are less than or about 2 hours,

```ELAPSED_TIME``` is the actual flight time. We can see the differnce between the estimated and actual time below.



```{r}
hist(flights$ELAPSED_TIME - flights$SCHEDULED_TIME)
```

Estimated time does provide a very accurate prediction, however this can vary by up to an hour or so.

```DISTANCE``` is how long the flight is. We can see the histogram below.

```{r}
hist(flights$DISTANCE)
```

Most the time flights are less than 1000 miles.

```WHEELS_ON``` is the time which the flight arrives.
```TAXI_IN``` is how long the flight takes to be taxi'd into the airport
```SCHEDULED_ARRIVAL``` is the schuled arival time
```ARRIVAL_TIME``` is the actual arival time
```ARRIVAL_DELAY``` is the difference between the actual and estimated arival time, we can see the distribution below.

```{r}
hist(flights$ARRIVAL_DELAY)
```
Most of the time there is almost no arrival delay.

```CANCELLED``` is if the flight was cancled or not. We can see a summary below.

```{r}
all_flights %>% 
  group_by(CANCELLED) %>% 
  count() %>% 
  arrange(desc(n))
```


Flights are very seldom canceled.

```CANCELLATION_REASON``` is the reason the flight was canceled. We can see a summary below.

```{r}
all_flights %>% 
  group_by(CANCELLATION_REASON) %>% 
  count() %>%
  drop_na() %>% 
  arrange(desc(n))
```
A is the most popular reason a flight is canceled.

`AIR_SYSTEM_DELAY`	`SECURITY_DELAY`	`AIRLINE_DELAY`	`LATE_AIRCRAFT_DELAY`	`WEATHER_DELAY` all describe the reason is a flight was canceled. They are all numeric only if a flight was delayed. Below are there histograms


```{r}
hist(all_flights$AIR_SYSTEM_DELAY)
hist(all_flights$SECURITY_DELAY)
hist(all_flights$AIRLINE_DELAY)
hist(all_flights$WEATHER_DELAY)
```

# Relationship between distance and air time


```{r}
ggplot(all_flights,aes(x = DISTANCE, y = AIR_TIME)) + geom_point()
```

There is a direct correlation between the distance and air time, this may be how the scheduled time for the flight is predicted. 

# Relation between deviation of schedule time and destination airport? 

Does the difference in the airline and the elapsed time depend the destination airport?

```{r}
all_flights$arrival_deviation <- flights$ELAPSED_TIME - flights$SCHEDULED_TIME

ggplot(all_flights,aes(x = AIRLINE, y = arrival_deviation)) + geom_boxplot()
```

All airlines in this data set predict well the arrival time at their estimation. Delta often over estimates their deviation a little, but not by much.

# Question 1: Is there a relationship between the airline and distance of the flight?

```{r}
ggplot(all_flights,aes(x = AIRLINE, y = DISTANCE)) + geom_boxplot()
```

Frontier Airlines Inc flies on average flies the longest distance flights. Skywest often flies the shortest flights out of all airlines. Delta flies almost everwhere. It has the largest spread in the dataset of distance and offers the most flights overall.

# Question 2: Where is frontier and skywest flying?

Frontier often flies the longest distance and skywest flies the shortest. It is interesting to visualize these airline's flights.

```{r}
maps::map("world", col="grey", fill=TRUE, border=0,bg="white", lwd=0.05, 
          xlim=c(-171.738281, -56.601563), ylim=c(12.039321, 71.856229)) #include the Alaska and Hawaii
fsub <- flights[flights$AIRLINE == "F9",]  #flights of  AA
for (j in 1:length(fsub$AIRLINE)) {        
  air1 <- airports[airports$IATA_CODE == fsub[j,]$ORIGIN_AIRPORT,]  #iata code for j flights in airport1
  air2 <- airports[airports$IATA_CODE == fsub[j,]$DESTINATION_AIRPORT,] #iata code for j flights in airport2
  inter <- gcIntermediate(c(air1[1,]$LONGITUDE, air1[1,]$LATITUDE), c(air2[1,]$LONGITUDE, air2[1,]$LATITUDE), n=100, addStartEnd=TRUE)  #calculate the great circles
  lines(inter, col="black", lwd=0.8)  #draw the line
}
```

From the map, frontier only flies longer flights. It is interesting frontier does not fly north from Cincinnati.

Next, we can look at skywest.

```{r}

maps::map("world", col="grey", fill=TRUE, border=0,bg="white", lwd=0.05, 
          xlim=c(-171.738281, -56.601563), ylim=c(12.039321, 71.856229)) #include the Alaska and Hawaii
fsub <- flights[flights$AIRLINE == "OO",]  #flights of  AA
for (j in 1:length(fsub$AIRLINE)) {        
  air1 <- airports[airports$IATA_CODE == fsub[j,]$ORIGIN_AIRPORT,]  #iata code for j flights in airport1
  air2 <- airports[airports$IATA_CODE == fsub[j,]$DESTINATION_AIRPORT,] #iata code for j flights in airport2
  inter <- gcIntermediate(c(air1[1,]$LONGITUDE, air1[1,]$LATITUDE), c(air2[1,]$LONGITUDE, air2[1,]$LATITUDE), n=100, addStartEnd=TRUE)  #calculate the great circles
  lines(inter, col="black", lwd=0.8)  #draw the line
}
```

Skywest for the majority flies in the midwest. There are some long distance flights, but many aren't too far. 

Just for a comparison, all the US airports which CVG services is shown in the plot below.

```{r}
maps::map("world", col="grey", fill=TRUE, border=0,bg="white", lwd=0.05, 
          xlim=c(-171.738281, -56.601563), ylim=c(12.039321, 71.856229)) #include the Alaska and Hawaii
fsub <- flights
for (j in 1:length(fsub$AIRLINE)) {        
  air1 <- airports[airports$IATA_CODE == fsub[j,]$ORIGIN_AIRPORT,]  #iata code for j flights in airport1
  air2 <- airports[airports$IATA_CODE == fsub[j,]$DESTINATION_AIRPORT,] #iata code for j flights in airport2
  inter <- gcIntermediate(c(air1[1,]$LONGITUDE, air1[1,]$LATITUDE), c(air2[1,]$LONGITUDE, air2[1,]$LATITUDE), n=100, addStartEnd=TRUE)  #calculate the great circles
  lines(inter, col="black", lwd=0.8)  #draw the line
}
```


# Question 3: Where does CVG service the most flights to? Where are the most flights to CVG serviced?

It will be interesting to see where CVG services the most flights to and also where the most flights from CVG are serviced. The spacial map below can be created to see the where the most flights go.

Below is the map for where flights are going to from CVG

```{r}
flights_state <- flights %>% 
  select(ORIGIN_AIRPORT) %>% 
  merge(airports, by.x = "ORIGIN_AIRPORT",by.y = "IATA_CODE") %>% 
  subset(STATE != "KY") %>% 
  group_by(STATE) %>% 
  count() %>% 
  mutate(state = STATE)
  

plot_usmap(data = flights_state, values = "n", color = "red") + 
  scale_fill_continuous(name = "CVG origin flights", label = scales::comma) + 
  theme(legend.position = "right")
```

Most of the CVG flights are heading to Illinois or Texas. Georgia and Florida are also popular destinations. 

Below is the map for CVG destination flights.

```{r}

flights_state <- flights %>% 
  select(DESTINATION_AIRPORT) %>% 
  merge(airports, by.x = "DESTINATION_AIRPORT",by.y = "IATA_CODE") %>% 
  subset(STATE != "KY") %>% 
  group_by(STATE) %>% 
  count() %>% 
  mutate(state = STATE)


plot_usmap(data = flights_state, values = "n", color = "red") + 
  scale_fill_continuous(name = "CVG destination flights", label = scales::comma) + 
  theme(legend.position = "right")
```

These two plots are almost identical in color. This shows there's just as many flights leaving the airport as coming in.